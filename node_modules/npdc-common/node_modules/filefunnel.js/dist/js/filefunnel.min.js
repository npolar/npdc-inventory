!function(){"use strict";function e(e,t){return"string"==typeof e?(t||document).querySelector(e):null}function t(e,t){return[].slice.call((t||document).querySelectorAll(e))}function n(e,t){"object"==typeof e&&e||(e={});for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n]);return e}function s(t,i){if(t instanceof s)return t;if(t instanceof HTMLElement&&!(this instanceof s))return new s(t,i);if(!(this instanceof s))return(t=e(t,i instanceof s?i.dom:i))?new s(t):null;i=n(i,{appendTo:null,context:document,html:"",insertAfter:null,insertBefore:null,replace:null});var o,r,a=t instanceof HTMLElement?t:null;if("string"==typeof t){r=function(e,t){return e.match(/(\[[^\]]+\]|#[^#.\[]+|\.[^#.\[]+|\w+)/g).forEach(function(e){"["==e[0]?(e=e.match(/^\[([^=\]]+)=?([^\]]+)?\]$/))&&(t.attribs[e[1]]=e[2]||""):"."==e[0]?t.classes.push(e.substr(1)):"#"==e[0]?t.attribs.id=e.substr(1):t.tag=e}),t}(t,{attribs:{},classes:[]}),a=i.context.createElement(r.tag),r.classes.forEach(function(e){a.classList.add(e)});for(o in r.attribs)r.attribs.hasOwnProperty(o)&&a.setAttribute(o,r.attribs[o])}this.events={},this.dom=t instanceof HTMLElement?t:a,this.parent=t instanceof HTMLElement?s(t.parentElement):null,i.html&&a&&(a.innerHTML=i.html),(o=s(i.replace))?o.parent.replace(this,o):(o=s(i.appendTo))?o.append(this):(o=s(i.insertAfter))?o.parent.append(this,o):(o=s(i.insertBefore))&&o.parent.insert(this,o)}function i(e,t){return this._callbacks={},this._elements={},this._i18n=i.i18n.en_GB,this._parent=s(e),this._options=n(t,{accept:"*/*",autoResize:!0,chunked:!1,chunkSize:1048576,className:"filefunnel",multiple:!1}),this.files=[],this.locale=t.locale||(navigator?(navigator.userLanguage||navigator.language).replace("-","_"):null),this.status=i.status.READY,this.build(),this}return s.prototype={add:function(e){return(e instanceof Array?e:[e]).forEach(function(e){(e=s(e))&&(this.dom.appendChild(e.dom),e.parent=this)},this),this},append:function(e,t){return(t=this.child(t))?this.dom.insertBefore(s(e).dom,t.dom.nextElementSibling):this.dom.appendChild(s(e).dom),e instanceof s&&(e.parent=this),this},attrib:function(e,t){if("string"==typeof e){if(void 0===t)return this.dom.getAttribute(e);this.dom.setAttribute(e,t)}return t},child:function(n){if("string"==typeof n){var i,o,r,a,l=this.dom;if(n.split(" ").forEach(function(t,n,s){l&&n<s.length-1&&(l=e(t,l))}),l){o=[].slice.call(l.children),a=t(n,l);for(r in a)for(i in o)if(a[r]===o[i])return s(o[i])}}else{if(n instanceof s)return n.dom.parentElement===this.dom?n:null;if(n instanceof HTMLElement)return n.parentElement===this.dom?s(n):null}return null},get classes(){return this.dom.classList},clear:function(){for(var e,t=this.dom;e=t.firstChild;)t.removeChild(e);return this},get enabled(){return!this.dom.hasAttribute("disabled")},set enabled(e){return e?this.dom.removeAttribute("disabled"):this.dom.setAttribute("disabled",""),this.enabled},focus:function(){this.dom.focus(),this.dom.selectionStart=this.value.length},get html(){return this.dom.innerHTML},set html(e){return this.dom.innerHTML=e},insert:function(e,t){return this.dom.insertBefore(s(e).dom,(t=this.child(t))?t.dom:this.dom.firstElementChild),e instanceof s&&(e.parent=this),this},on:function(e,t,n){return(e instanceof Array?e:[e]).forEach(function(e){if("string"==typeof e){var s=this,i="function"==typeof t?function(e){return t.call(n||s,e)}:null;s.events[e]instanceof Array||(s.events[e]=[]),i?(s.events[e].push(i),s.dom.addEventListener(e,i)):s.events[e].forEach(function(t,n,i){s.dom.removeEventListener(e,t),i.splice(n,1)})}},this),this},remove:function(e){(e=s(e))&&this.dom.removeChild(e.dom)},replace:function(e,t){return(e=new s(e))&&(t=s(t,this))&&(this.dom.replaceChild(e.dom,t.dom),e.parent=this,t.parent=null),this},get value(){return void 0!==this.dom.value?this.dom.value:this.html},set value(e){return void 0!==this.dom.value?this.dom.value=e:this.html=e},get visible(){return!this.dom.hasAttribute("hidden")},set visible(e){return e?this.dom.removeAttribute("hidden"):this.dom.setAttribute("hidden",""),this.visible}},i.VERSION=.46,i.status={READY:0,UPLOADING:1,COMPLETED:2,ABORTED:3,FAILED:4},i.prototype={browse:function(){this._elements.fileInput&&this._elements.fileInput.dom.click()},build:function(){var e=this,t=e.files,n=e._i18n,o=e._options,r=e._parent,a="string"==typeof o.accept?o.accept:"*/*",l={form:new s("form[enctype=multipart/form-data][method=POST]."+o.className),browseButton:new s("input[type=button][value="+(o.multiple?n.browseMultiple:n.browse)+"].browse"),fileInput:new s("input[type=file][accept="+a+"][hidden][multiple]"),fileList:new s("div.filelist"),submitButton:new s("input[type=submit][value="+n.upload+"][disabled].submit"),resetButton:new s("input[type=reset][value="+n.reset+"].reset")},u={401:n.forbidden,403:n.forbidden,413:n.oversized};return!0!==o.multiple&&l.fileInput.dom.removeAttribute("multiple"),l.form.add([l.browseButton,l.fileInput,l.fileList,l.submitButton,l.resetButton]),r&&(e._elements.form&&e._elements.form.parent?e._elements.form.parent.replace(l.form,e._elements.form):r.dom instanceof HTMLInputElement?(r.parent.append(l.form,r),l.form.classes.add("widget"),e._elements=l,e.hide().resize(),r.on("click",function(){e.toggle()}),document.addEventListener("click",function(t,n){if(l.form.visible){for(;n=n?n.parentNode:t.target;)if(n==l.form.dom||n==r.dom)return;e.hide()}}),window.addEventListener("resize",function(){!0===o.autoResize&&e.resize()})):r.append(l.form)),e._elements=l,l.browseButton.on("click",function(){l.fileInput.dom.click()}),l.fileInput.on("change",function(o){t.length=0,l.fileList.clear(),l.fileListItems=[],[].slice.call(o.target.files).forEach(function(e){var o=e.size,r=(e.lastModifiedDate,{});o=o>=1073741824?(o/1073741824).toFixed(2)+n.gibiBytes:o>=1048576?(o/1048576).toFixed(2)+n.mebiBytes:o>=1024?(o/1024).toFixed(2)+n.kibiBytes:o+=n.bytes,l.fileList.add(new s("fieldset.fileinfo").append(new s("legend",{html:e.name})).append(r.name=new s("input[type=text][placeholder="+n.fileName+"][value="+e.name+"].name")).append(r.size=new s("input[type=text][placeholder="+n.fileSize+"][value="+o+"][disabled].size")).append(r.type=new s("input[type=text][placeholder="+n.fileType+"][value="+e.type+"][disabled].type")).append(r.prog=new s("progress[value=0].progress")).append(r.info=new s("span.info"))),t.push({elements:r,location:null,reference:e,response:null,status:i.status.READY,get progress(){return i.status.UPLOADING==this.status?Math.round(this.elements.prog.value/this.elements.prog.max*100):NaN}})}),e.status=i.status.READY,l.submitButton.enabled=o.target.files.length}),l.form.on("submit",function(t){t.preventDefault(),e.upload()}),e.upload=function(){function s(s){for(var o in t)if(i.status.UPLOADING==t[o].status)return;l.fileInput.enabled=!0,l.resetButton.value=n.reset,e.status=i.status.COMPLETED}if(l.fileInput.enabled=l.submitButton.enabled=!1,l.resetButton.value=n.cancel,e.status=i.status.UPLOADING,o.chunked){var r="number"==typeof o.chunkSize?o.chunkSize:1048576;t.forEach(function(t){var a=0,l=t.reference.size,c=t.elements.name.value,f=function(){var d=t.reference.slice(a,Math.min(l,a+r)+1,t.reference.type),m=new XMLHttpRequest;m.onloadstart=function(n){t.status=i.status.UPLOADING,t.elements.prog.attrib("max",l+(n.lengthComputable?n.total:0)),t.elements.prog.value=a,"function"==typeof e._callbacks.start&&e._callbacks.start(t)},m.upload.onprogress=function(n){n.lengthComputable&&(t.elements.prog.value=a+n.loaded),"function"==typeof e._callbacks.progress&&e._callbacks.progress(t)},m.onload=function(o){var r=o.target.status;if(r>=200&&300>r){if(t.elements.prog.attrib("max",l),t.elements.prog.value=a+=d.size,l>a)return"function"==typeof f&&f();t.status=i.status.COMPLETED,t.elements.info.classes.add("success"),t.elements.info.value=n.success,s(t),201==r&&(t.location=m.getResponseHeader("Content-Location")||null,t.response=m.responseText||null),"function"==typeof e._callbacks.success&&e._callbacks.success(t)}else r>=400&&(t.status=i.status.FAILED,t.elements.info.classes.add("error"),t.elements.info.value=u[r]||n.failed,s(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t))},m.onabort=function(){t.status=i.status.ABORTED,t.elements.info.value=n.aborted,s(t),"function"==typeof e._callbacks.abort&&e._callbacks.abort(t)},m.ontimeout=function(){t.status=i.status.FAILED,t.elements.info.classes.add("error"),t.elements.info.value=n.timeout,s(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t)},m.onerror=function(){t.status=i.status.FAILED,t.elements.info.classes.add("error"),t.elements.info.value=n.refused,s(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t)},m.open("POST",o.server,!0),m.setRequestHeader("Content-Type",d.type),m.setRequestHeader("X-File-Name",c),m.setRequestHeader("X-File-Size",l),m.send(d)};t.elements.prog.attrib("max",l),f()})}else{var a=t.xhr=new XMLHttpRequest,c=new FormData;a.onloadstart=function(n){t.forEach(function(t){t.status=i.status.UPLOADING,"function"==typeof e._callbacks.start&&e._callbacks.start(t)})},a.onload=function(o){var r=o.target.status;t.forEach(function(t){r>=200&&r>300?(t.elements.prog.attrib("max",o.total||1),t.elements.prog.attrib("value",o.loaded||1),t.elements.info.classes.add("success"),t.elements.info.value=n.success,s(t),"function"==typeof e._callbacks.success&&e._callbacks.success(t)):r>=400&&(t.status=i.status.FAILED,t.elements.info.classes.add("error"),t.elements.info.value=u[r]||n.failed,s(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t))})},a.onabort=function(){t.forEach(function(t){t.status=i.status.ABORTED,t.elements.info.value=n.aborted,s(t),"function"==typeof e._callbacks.abort&&e._callbacks.abort(t)})},a.ontimeout=function(){t.forEach(function(t){t.status=i.status.FAILED,t.elements.info.classes.add("error"),t.elements.info.value=n.timeout,s(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t)})},a.onerror=function(o){t.forEach(function(t){t.status=i.status.FAILED,t.elements.info.classes.add("error"),t.elements.info.value=n.refused,s(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t)})},t.forEach(function(e){c.append(e.reference.name,e.reference,e.elements.name.value),e.elements.prog.dom.removeAttribute("value")}),a.open("POST",o.server,!0),a.send(c)}},l.form.on("reset",function(){l.fileList.clear(),l.fileListItems=[],l.fileInput.enabled=!0,l.submitButton.enabled=!1,l.resetButton.value=n.reset}),this},hide:function(){return this._elements.form&&(this._elements.form.visible=!1),this},get locale(){for(var e in i.i18n)if(this._i18n==i.i18n[e])return e},set locale(e){i.i18n[e]&&i.i18n[e]!==this._i18n&&(this._i18n=i.i18n[e])},on:function(e,t){if(-1==["start","progress","success","abort","error"].indexOf(e))throw"Unrecognized FileFunnel event: "+e;return this._callbacks[e]="function"==typeof t?t:null,this},resize:function(e){return this._elements.form&&this._parent&&(this._elements.form.dom.style.width=(isNaN(e=Number(e))?this._parent.dom.offsetWidth:e)+"px"),this},show:function(){return this._elements.form&&(this._elements.form.visible=!0),this},toggle:function(){return this._elements.form&&(this._elements.form.visible=!this._elements.form.visible),this},upload:function(){}},i.i18n={en_GB:{browse:"Choose file",browseMultiple:"Choose files",cancel:"Cancel","delete":"Delete",reset:"Reset",upload:"Upload",bytes:" bytes",gibiBytes:" GiB",kibiBytes:" KiB",mebiBytes:" MiB",fileName:"Filename",fileSize:"Filesize",fileType:"Filetype",aborted:"Upload aborted",failed:"Upload failed",forbidden:"Unauthorised for upload",oversized:"File too big for upload",refused:"Connection refused",success:"Upload successful",timeout:"Upload timed out"}},"undefined"!=typeof window&&(window.FileFunnel=i),"object"==typeof module&&module.exports&&(module.exports=i),i}();